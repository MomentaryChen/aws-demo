# aws-demo

**Language**: English | [ÁπÅÈ´î‰∏≠Êñá](README_ZH.md)

---

A demonstration project using LocalStack to simulate AWS Lambda, featuring two main automation scripts:

- **autoDeploy.cmd**: Build, package, and update Lambda (including environment variable configuration)
- **autoExec.cmd**: Invoke Lambda and collect/decode execution logs

With these two scripts, developers can quickly iterate Lambda code and verify execution results locally.

---

## Project Structure

```
aws-demo/
  autoDeploy.cmd          # Package and update Lambda (LocalStack)
  autoExec.cmd            # Invoke Lambda and output logs to result/
  src/                    # TypeScript source code (handler, db, model)
  dist/                   # Compiled output and package (function.zip)
  result/                 # Output and logs generated by autoExec
  event.json              # Sample event (can be customized)
  package.json            # NPM scripts and dependencies
  tsconfig.json           # TypeScript configuration
  aws-lambda-log-previewer/ # React frontend log viewer (optional)
```

Default Lambda Name: `localstack-lambda-url-example`

CloudWatch Log Group: `/aws/lambda/localstack-lambda-url-example`

---

## Prerequisites

- Windows (`.cmd` scripts)
- Node.js 18+ and npm
- TypeScript (installed via project `devDependencies`)
- LocalStack (running locally)
- AWS CLI and awslocal (or equivalent alias)
- 7-Zip (command-line `7z`, used for compressing `function.zip`)
- certutil (built-in Windows tool, used for Base64 decoding logs)

Installation Tips:

- awslocal can be installed via `pip install awscli-local` or use `aws --endpoint-url=http://localhost:4566` as an alternative.
- Ensure `7z` is added to PATH for 7-Zip.

---

## Quick Start

1. **Install dependencies**

```
npm install
```

2. **Ensure LocalStack is running and a Lambda named `localstack-lambda-url-example` has been created.**

3. **Deploy (build + package + update Lambda)**

Double-click or run from command line in the project root:

```
autoDeploy.cmd
```

After success, `dist/function.zip` will be uploaded to the Lambda in LocalStack. The script will also set (override) the following environment variables:

```
DB_HOST=host.docker.internal
DB_USER=root
DB_PASSWORD=root123456
DB_NAME=demo
```

4. **Execute Lambda and collect logs**

```
autoExec.cmd
```

After execution, the following files will be generated:

- `result/output.json`: Lambda response payload
- `result/log.b64`: Base64-encoded execution log
- `result/log.txt`: Decoded execution log (readable)
- `result/log/full-events-log.json`: Complete event log exported from CloudWatch Logs (multiple entries)

---

## autoDeploy.cmd Documentation

Main Process:

1. Delete old `dist/`
2. Compile TypeScript to `dist/` using `npm run build`
3. Use `7z` to package `dist/*` and `node_modules` into `dist/function.zip`
4. Update Lambda code using `awslocal lambda update-function-code`
5. Override environment variables using `aws --endpoint-url=http://localhost:4566 lambda update-function-configuration`

Common Issues:

- `7z` not found: Ensure 7-Zip is installed and its path is added to PATH.
- `awslocal` command not found: Use `aws --endpoint-url=http://localhost:4566` instead.
- Build failed: Manually run `npm run build` in the command line to see detailed errors.

---

## autoExec.cmd Documentation

Main Process:

1. Clear and create `result/`
2. Invoke `localstack-lambda-url-example` using `awslocal lambda invoke`
   - Request payload example:
     ```json
     { "body": { "num1": "10", "num2": "10" } }
     ```
   - Lambda response saved to `result/output.json`
   - `--log-type Tail` retrieves Base64 log (written to `result/log.b64`)
3. Use `certutil -decode` to convert `log.b64` to `result/log.txt`
4. Export complete events to `result/log/full-events-log.json` using `awslocal logs filter-log-events`

You can modify the `--payload` in the script to test different inputs.

---

## NPM Scripts (Summary)

Please check the root `package.json` for complete commands; generally:

```
npm run build    # Compile TypeScript to dist/
```

---

## Frontend Log Viewer (Optional)

The `aws-lambda-log-previewer/` directory contains a React-based log viewer application that provides a user-friendly interface for viewing and filtering Lambda execution logs.

**Features:**
- üìä Visual log table with sortable columns
- üîç JSON detail viewer for log events
- üé® Modern Material-UI interface
- üì§ Upload and preview `result/log/full-events-log.json` files

**Quick Start:**

1. Navigate to the log viewer directory:
   ```bash
   cd aws-lambda-log-previewer
   ```

2. Install dependencies:
   ```bash
   npm install
   ```

3. Start the development server:
   ```bash
   npm start
   ```

4. Upload the generated log file (`result/log/full-events-log.json`) through the web interface.

For more details, see [aws-lambda-log-previewer/README.md](aws-lambda-log-previewer/README.md).

---

## Tips

- To test directly with `event.json`, modify the `--payload` in `autoExec.cmd`, or read the default event in the Lambda handler.
- If running LocalStack in Docker, database addresses often use `host.docker.internal` (already set as default in environment variables).

---

## License & Maintenance

This project is for educational and demonstration purposes only. PRs and Issues are welcome for improvement suggestions.
